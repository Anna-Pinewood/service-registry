stages:
  - prepare
  - build
  - deploy

variables:
  IMAGE_REGISTRY: 65.108.52.119:5000
  IMAGE_NAME: web_app
  SWARM_MANAGER: 65.108.52.119

get_secret:
  stage: prepare
  image: python:3.9
  rules:
    - if: '$CI_COMMIT_BRANCH == "TEST" || $CI_COMMIT_BRANCH == "PROD"'
  services:
    - name: waryak/karpov_courses:secret_ci_service
      alias: waryak
  script:
    - export SOURCE_BRANCH_LOW=$(echo '$CI_COMMIT_BRANCH' | tr '[:upper:]' '[:lower:]')
    - echo $SOURCE_BRANCH_LOW
    - echo "Using link"
    - echo http://waryak:5000/get_secret_number/${SOURCE_BRANCH_LOW}
    - SECRET_NUMBER=$(curl -s http://waryak:5000/get_secret_number/$CI_COMMIT_BRANCH)
    - echo $SECRET_NUMBER
    - echo "SECRET_NUMBER=$SECRET_NUMBER" >> $CI_ENVIRONMENT_PATH
  artifacts:
    reports:
      dotenv: $CI_ENVIRONMENT_PATH
  dependencies: []


build-job:
  stage: build
  before_script:
    - echo $SECRET_NUMBER
    - 'which ssh-agent || ( apt-get install -qq openssh-client )'
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh
    - 'echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
    - echo "${SSH_PRIVATE_KEY_ENCODED}" | base64 --decode | ssh-add -
    - ssh root@$SWARM_MANAGER "ls"
    - echo "Successfuly connected to remote server."
  script:
    - ssh root@$SWARM_MANAGER "docker image rm $IMAGE_REGISTRY/$IMAGE_NAME"
    - ssh root@SWARM_MANAGER "git pull origin $CI_"
  



deploy-job:      # This job runs in the deploy stage.
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  environment: production
  script:
    - echo "Deploying application..."
    - echo "Application successfully deployed."
